<!DOCTYPE html>
<html lang="es">
<head>

<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-storage-compat.js"></script>

<script>

  const firebaseConfig = {
    apiKey: "AIzaSyBb1n1VqR8iXco8ByeCkze_XewNjoH6Ruk",
    authDomain: "listacompraapp-dae10.firebaseapp.com",
    projectId: "listacompraapp-dae10",
    storageBucket: "listacompraapp-dae10.firebasestorage.app",
    messagingSenderId: "68249280755",
    appId: "1:68249280755:web:e359ca073cab688f031786",
    measurementId: "G-M3Z4FJJZ4W"
  };

 firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

</script>


  <meta charset="UTF-8" />
  <title>Lista de la compra con usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f9f9f9;
    }
    h1 {
      margin-bottom: 30px;
      font-size: 28px;
      text-align: center;
    }

    #authView {
      max-width: 400px;
      width: 100%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
    }
    #authView h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      text-align: center;
    }
    #authView input[type="email"],
    #authView input[type="password"]{
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #authView button {
      width: 100%;
      padding: 10px;
      background-color: #4caf50;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    #authView .toggle {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }
    #authView .toggle span {
      color: #4caf50;
      text-decoration: underline;
    }

    #appView {
      display: none;
      width: 100%;
      max-width: 500px;
    }
    #appView.active {
      display: block;
    }

    .input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .logout-btn {
      margin-bottom: 15px;
      background: #ddd;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      align-self: flex-end;
    }

    .menu-container {
  position: relative;
  display: inline-block;
}

.menu-btn {
  background: #ddd;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
}

.menu-btn:hover {
  background: #ccc;
}

.menu-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  min-width: 150px;
  z-index: 1000;
  margin-top: 2px;
}

.menu-dropdown.show {
  display: block;
}

.menu-item {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 16px;
  border-bottom: 1px solid #eee;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:hover {
  background: #f5f5f5;
}

    .list-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .list-button {
      padding: 20px;
      font-size: 20px;
      border: 2px solid #888;
      border-radius: 10px;
      background: #f3f3f3;
      cursor: pointer;
      text-align: center;
    }

.back-btn {
  margin-bottom: 15px;
  background: #ddd;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  height: 42px; /* Altura fija para que coincida con el menú */
  display: flex;
  align-items: center;
  justify-content: center;
}

    .list-container {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
    }

    h2.list-title.editable {
      cursor: pointer;
      font-size: 24px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    .form {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .form input[type="text"] {
      font-size: 18px;
      padding: 8px;
      flex: 1;
    }

    .form button {
      font-size: 30px;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      background-color: #4caf50;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

.item img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  margin-right: 10px;
  border-radius: 6px;
  cursor: pointer;
  flex-shrink: 0; /* Para que no se reduzca el tamaño */
}

.item img.default-img {
  width: 50px;
  height: 50px;
  opacity: 0.7;
  object-fit: contain; /* Para que el icono se vea completo */
}

.item input[type="checkbox"] {
  margin-right: 10px;
  width: 22px;
  height: 22px;
  flex-shrink: 0; /* Para que no se reduzca */
}

    .item span.editable {
      cursor: pointer;
      font-size: 18px;
    }

    .item span.checked {
      text-decoration: line-through;
      color: gray;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

  </style>
</head>
<body>

  <h1>Lista de la compra con usuarios</h1>

  <div id="authView">
    <h2 id="authTitle">Iniciar sesión</h2>
    <form id="authForm">
      <input type="text" id="username" placeholder="Usuario" class="input" style="display:none;" />
      <input type="email" id="email" placeholder="Correo electrónico" required class="input"/>
      <input type="password" id="password" placeholder="Contraseña" required class="input"/>
      <input type="password" id="confirmPassword" placeholder="Repetir contraseña" class="input" style="display:none;" />
      <button type="submit" id="authButton">Entrar</button>
    </form>
    <div class="toggle" id="toggleAuth">¿No tienes cuenta? <span>Regístrate</span></div>
    <p id="authMessage" style="color:red; text-align:center; margin-top:10px;"></p>
  </div>

  <div id="appView">
    
    <div id="modal" class="modal" onclick="closeModal()">
      <img id="modalImage" src="" alt="Vista ampliada" />
    </div>

    <div id="selectorView" class="list-selector">
     <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
  <div class="menu-container">
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
    <div class="menu-dropdown" id="menuDropdown">
      <div class="menu-item" onclick="logout()">Cerrar sesión</div>
    </div>
  </div>
</div>
  <div class="list-button" id="list1Button" onclick="showList('list1View')">Lista 1</div>
  <div class="list-button" id="list2Button" onclick="showList('list2View')">Lista 2</div>
</div>

    <div id="list1View" class="view" style="display:none;">
      <div class="top-bar">
  <button class="back-btn" onclick="showList('selectorView')">←</button>
  <div class="menu-container">
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
    <div class="menu-dropdown" id="menuDropdown2">
      <div class="menu-item" onclick="logout()">Cerrar sesión</div>
    </div>
  </div>
</div>
      <div class="list-container">
        <h2 class="list-title editable" data-button-id="list1Button" onclick="editListTitle(this)">Lista 1</h2>
        <form class="form" onsubmit="addItem(event, 'list1')">
          <input type="text" placeholder="Nombre del artículo" id="name-list1" required />
          <button type="submit">+</button>
        </form>
        <div id="list1"></div>
      </div>
    </div>

    <div id="list2View" class="view" style="display:none;">
      <div class="top-bar">
  <button class="back-btn" onclick="showList('selectorView')">←</button>
  <div class="menu-container">
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
    <div class="menu-dropdown" id="menuDropdown3">
      <div class="menu-item" onclick="logout()">Cerrar sesión</div>
    </div>
  </div>
</div>
      <div class="list-container">
        <h2 class="list-title editable" data-button-id="list2Button" onclick="editListTitle(this)">Lista 2</h2>
        <form class="form" onsubmit="addItem(event, 'list2')">
          <input type="text" placeholder="Nombre del artículo" id="name-list2" required />
          <button type="submit">+</button>
        </form>
        <div id="list2"></div>
      </div>
    </div>
  </div>

  <script>
    
    let currentUser = null;

    const usernameInput = document.getElementById('username');
    const mainTitle = document.querySelector('h1');
    const authView = document.getElementById('authView');
    const appView = document.getElementById('appView');
    const authTitle = document.getElementById('authTitle');
    const authForm = document.getElementById('authForm');
    const authButton = document.getElementById('authButton');
    const toggleAuth = document.getElementById('toggleAuth');
    const authMessage = document.getElementById('authMessage');
    let authMode = 'login';

    toggleAuth.addEventListener('click', () => {
      authMode = authMode === 'login' ? 'register' : 'login';
      authTitle.textContent = authMode === 'login' ? 'Iniciar sesión' : 'Regístrate';
      authButton.textContent = authMode === 'login' ? 'Entrar' : 'Registrar';
      toggleAuth.innerHTML = authMode === 'login' ? '¿No tienes cuenta? <span>Regístrate</span>' : '¿Ya tienes cuenta? <span>Inicia sesión</span>';
      authMessage.textContent = '';

     const confirmPasswordInput = document.getElementById('confirmPassword');
if (authMode === 'register') {
  usernameInput.style.display = 'block';
  usernameInput.required = true;
  confirmPasswordInput.style.display = 'block';
  confirmPasswordInput.required = true;
} else {
  usernameInput.style.display = 'none';
  usernameInput.required = false;
  confirmPasswordInput.style.display = 'none';
  confirmPasswordInput.required = false;
}
    });

    authForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const username = document.getElementById("username").value.trim();

  if (authMode === "register") {
    if (password !== confirmPassword) {
      authMessage.textContent = "Las contraseñas no coinciden.";
      return;
    }
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      await db.collection("users").doc(user.uid).set({
  username: username,
  email: email,
  lists: {
    list1: [],
    list2: []
  },
  itemLibrary: {} // Nueva biblioteca de artículos del usuario
});

      currentUser = user;
      mainTitle.textContent = `Lista de la compra de ${username}`;
      authView.style.display = 'none';
      appView.classList.add('active');
      // Aquí puedes cargar listas desde Firestore más adelante.
    } catch (error) {
      authMessage.textContent = error.message;
    }
  } else {
    // LOGIN
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;

const doc = await db.collection("users").doc(user.uid).get();
const userData = doc.data();

currentUser = user;
mainTitle.textContent = `Lista de la compra de ${userData.username}`;

// Cargar nombres de listas guardados
if (userData.list1Name) {
  document.querySelector('[data-button-id="list1Button"]').textContent = userData.list1Name;
  document.getElementById('list1Button').textContent = userData.list1Name;
}
if (userData.list2Name) {
  document.querySelector('[data-button-id="list2Button"]').textContent = userData.list2Name;
  document.getElementById('list2Button').textContent = userData.list2Name;
}

authView.style.display = 'none';
appView.classList.add('active');
loadLists();
      // Aquí puedes cargar listas desde Firestore más adelante.
    } catch (error) {
      authMessage.textContent = error.message;
    }
  }
});



    function logout() {
    currentUser = null;
  appView.classList.remove('active');
  authView.style.display = 'block';
  authForm.reset();
  mainTitle.textContent = 'Lista de la compra con usuarios';
    }

    function showList(viewId) {
      document.getElementById('selectorView').style.display = 'none';
      document.getElementById('list1View').style.display = 'none';
      document.getElementById('list2View').style.display = 'none';
      if (viewId === 'selectorView') {
  document.getElementById('selectorView').style.display = 'flex';  // para que mantenga flex y gap
} else {
  document.getElementById(viewId).style.display = 'block';
}
    }

    async function loadLists() {
  if (!currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const data = userData.lists || { list1: [], list2: [] };
    
['list1', 'list2'].forEach(listId => {
  const container = document.getElementById(listId);
  container.innerHTML = '';
  const orderedList = reorderList(data[listId] || []);
  orderedList.forEach((item, index) => {
  const el = document.createElement('div');
  el.className = 'item';
  const img = document.createElement('img');
  img.src = item.img || 'https://cdn-icons-png.flaticon.com/512/685/685655.png';
  img.className = item.img ? '' : 'default-img';
  img.onclick = () => {
    if (!item.img) {
      selectImage(index, listId);
    } else {
      document.getElementById('modalImage').src = item.img;
      document.getElementById('modal').style.display = 'flex';
    }
  };
        const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.checked = item.checked;
checkbox.onchange = async () => {
  item.checked = checkbox.checked;
  
  // Reordenar la lista: no marcados primero, marcados al final
  const reorderedList = data[listId].sort((a, b) => {
    if (a.checked === b.checked) return 0;
    return a.checked ? 1 : -1; // Los marcados (true) van al final
  });
  
  await saveItemToFirebase(listId, reorderedList);
  loadLists(); // Recargar para mostrar el nuevo orden
};
        const span = document.createElement('span');
        span.textContent = item.name;
        span.className = 'editable' + (item.checked ? ' checked' : '');
        el.append(checkbox, img, span);
        container.appendChild(el);
      });
    });
  } catch (error) {
    console.error("Error al cargar listas:", error);
  }
}

async function saveItemToFirebase(listId, items) {
  if (!currentUser) return;
  try {
    await db.collection("users").doc(currentUser.uid).update({
      [`lists.${listId}`]: items
    });
  } catch (error) {
    console.error("Error al guardar en Firebase:", error);
  }
}

function reorderList(list) {
  // Separar elementos marcados y no marcados
  const unchecked = list.filter(item => !item.checked);
  const checked = list.filter(item => item.checked);
  
  // Devolver primero los no marcados, luego los marcados
  return [...unchecked, ...checked];
}

async function addItem(e, listId) {
  e.preventDefault();
  const input = document.getElementById(`name-${listId}`);
  const name = input.value.trim();
  if (!name || !currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const currentList = userData.lists[listId] || [];
    const itemLibrary = userData.itemLibrary || {};
    
    // Crear el nuevo item
    const newItem = { name, checked: false };
    
    // Si el artículo ya existe en la biblioteca, usar su imagen
    const normalizedName = name.toLowerCase().trim();
    if (itemLibrary[normalizedName] && itemLibrary[normalizedName].img) {
      newItem.img = itemLibrary[normalizedName].img;
      console.log('Usando imagen guardada para:', name);
    }
    
    currentList.unshift(newItem);
    
    // Reordenar la lista antes de guardar
const reorderedList = reorderList(currentList);

await db.collection("users").doc(currentUser.uid).update({
  [`lists.${listId}`]: reorderedList
});
    
    input.value = '';
    loadLists();
  } catch (error) {
    console.error("Error al añadir artículo:", error);
  }
}

    function saveList(listId, items) {
      const data = JSON.parse(localStorage.getItem(`listApp_${currentUser}`));
      data[listId] = items;
      localStorage.setItem(`listApp_${currentUser}`, JSON.stringify(data));
    }

async function selectImage(itemIndex, listId) {
  console.log('Seleccionando imagen para item:', itemIndex, 'en lista:', listId);
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Archivo seleccionado:', file.name);
    
    try {
      // Crear una referencia única para la imagen
      const imageRef = storage.ref(`images/${currentUser.uid}/${listId}/${itemIndex}_${Date.now()}`);
      
      // Subir la imagen a Firebase Storage
      console.log('Subiendo imagen a Storage...');
      const snapshot = await imageRef.put(file);
      
      // Obtener la URL de descarga
      const downloadURL = await snapshot.ref.getDownloadURL();
      console.log('URL de imagen obtenida:', downloadURL);
      
      // Obtener la lista actual de Firebase
      const doc = await db.collection("users").doc(currentUser.uid).get();
      const userData = doc.data();
      const currentList = userData.lists[listId] || [];
      const itemLibrary = userData.itemLibrary || {};
      
      console.log('Lista actual:', currentList);
      console.log('Item a actualizar:', currentList[itemIndex]);
      
      // Actualizar el item específico usando el índice
      if (currentList[itemIndex]) {
        currentList[itemIndex].img = downloadURL;
        
        // Guardar también en la biblioteca del usuario
        const normalizedName = currentList[itemIndex].name.toLowerCase().trim();
        itemLibrary[normalizedName] = {
          name: currentList[itemIndex].name,
          img: downloadURL
        };
        
        console.log('Item actualizado con URL de imagen y guardado en biblioteca');
        
        // Guardar tanto la lista como la biblioteca
        await db.collection("users").doc(currentUser.uid).update({
          [`lists.${listId}`]: currentList,
          itemLibrary: itemLibrary
        });
        
        console.log('Guardado en Firebase');
        
        // Recargar las listas para mostrar la nueva imagen
        loadLists();
      }
    } catch (error) {
      console.error("Error al guardar imagen:", error);
    }
  };
  input.click();
}

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

async function editListTitle(element) {
  const currentTitle = element.textContent;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentTitle;
  input.style.fontSize = '24px';
  input.style.width = '100%';

  input.onblur = async () => {
    const newTitle = input.value.trim() || currentTitle;
    element.textContent = newTitle;

    const buttonId = element.getAttribute('data-button-id');
    const button = document.getElementById(buttonId);
    if (button) button.textContent = newTitle;

    // Guardar en Firebase
    if (currentUser && newTitle !== currentTitle) {
      try {
        const listKey = buttonId === 'list1Button' ? 'list1Name' : 'list2Name';
        await db.collection("users").doc(currentUser.uid).update({
          [listKey]: newTitle
        });
      } catch (error) {
        console.error("Error al guardar el nombre de la lista:", error);
      }
    }

    // Volver a activar la edición si se hace clic de nuevo
    element.onclick = () => editListTitle(element);
  };

  element.textContent = '';
  element.onclick = null; // quitar el evento mientras se edita
  element.appendChild(input);
  input.focus();
}

function toggleMenu() {
  const dropdowns = document.querySelectorAll('.menu-dropdown');
  dropdowns.forEach(dropdown => {
    dropdown.classList.toggle('show');
  });
}

// Cerrar el menú si se hace clic fuera de él
document.addEventListener('click', function(event) {
  const menuContainers = document.querySelectorAll('.menu-container');
  let clickedInsideMenu = false;
  
  menuContainers.forEach(container => {
    if (container.contains(event.target)) {
      clickedInsideMenu = true;
    }
  });
  
  if (!clickedInsideMenu) {
    const dropdowns = document.querySelectorAll('.menu-dropdown');
    dropdowns.forEach(dropdown => {
      dropdown.classList.remove('show');
    });
  }
});

  </script>

</body>
</html>
