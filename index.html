<!DOCTYPE html>
<html lang="es">
<head>

<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.1/firebase-storage-compat.js"></script>

<script>

  const firebaseConfig = {
    apiKey: "AIzaSyBb1n1VqR8iXco8ByeCkze_XewNjoH6Ruk",
    authDomain: "listacompraapp-dae10.firebaseapp.com",
    projectId: "listacompraapp-dae10",
    storageBucket: "listacompraapp-dae10.firebasestorage.app",
    messagingSenderId: "68249280755",
    appId: "1:68249280755:web:e359ca073cab688f031786",
    measurementId: "G-M3Z4FJJZ4W"
  };

 firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

</script>


  <meta charset="UTF-8" />
  <title>Lista de la compra by AKOBU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA: Enlace al manifest -->
<link rel="manifest" href="/manifest.json">

<!-- PWA: Meta tags para iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Mi App">

<!-- PWA: Iconos para iOS -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

<!-- PWA: Meta tags generales -->
<meta name="theme-color" content="#000000">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<!-- PWA: Favicon est√°ndar -->
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: #f9f9f9;
    }
    h1 {
      margin-bottom: 30px;
      font-size: 28px;
      text-align: center;
      display: none; /* Oculto por defecto */
    }

#authView {
      max-width: 400px;
      width: 100%;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
      display: none; /* Oculto por defecto */
    }

    #authView h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 24px;
      text-align: center;
    }
    #authView input[type="email"],
    #authView input[type="password"]{
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #authView button {
      width: 100%;
      padding: 10px;
      background-color: #4caf50;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    #authView .toggle {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #555;
      cursor: pointer;
    }
    #authView .toggle span {
      color: #4caf50;
      text-decoration: underline;
    }

    #appView {
      display: none;
      width: 100%;
      max-width: 500px;
    }
    #appView.active {
      display: block;
    }

    .input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .logout-btn {
      margin-bottom: 15px;
      background: #ddd;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      align-self: flex-end;
    }

    .menu-container {
  position: relative;
  display: inline-block;
}

.menu-btn {
  background: #ddd;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 18px;
  cursor: pointer;
  font-weight: bold;
  height: 42px; /* Misma altura que el bot√≥n volver */
  display: flex;
  align-items: center;
  justify-content: center;
}

.menu-btn:hover {
  background: #ccc;
}

.menu-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  min-width: 150px;
  z-index: 1000;
  margin-top: 2px;
}

.menu-dropdown.show {
  display: block;
}

.menu-item {
  padding: 12px 16px;
  cursor: pointer;
  font-size: 16px;
  border-bottom: 1px solid #eee;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:hover {
  background: #f5f5f5;
}

    .list-selector {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }

    .list-button {
      padding: 20px;
      font-size: 20px;
      border: 2px solid #888;
      border-radius: 10px;
      background: #f3f3f3;
      cursor: pointer;
      text-align: center;
    }

.back-btn {
  background: #ddd;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
}

    .list-container {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
    }

    h2.list-title.editable {
      cursor: pointer;
      font-size: 24px;
      margin-top: 0;
      margin-bottom: 20px;
    }

    .form {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }

    .form input[type="text"] {
      font-size: 18px;
      padding: 8px;
      flex: 1;
    }

    .form button {
      font-size: 30px;
      height: 30px;
      width: 30px;
      border-radius: 50%;
      background-color: #4caf50;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

.item img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  margin-right: 10px;
  border-radius: 6px;
  cursor: pointer;
  flex-shrink: 0; /* Para que no se reduzca el tama√±o */
}

.item img.default-img {
  width: 40px;
  height: 40px;
  opacity: 0.7;
  object-fit: contain; /* Para que el icono se vea completo */
}

.item input[type="checkbox"] {
  margin-right: 10px;
  width: 22px;
  height: 22px;
  flex-shrink: 0; /* Para que no se reduzca */
}

    .item span.editable {
      cursor: pointer;
      font-size: 18px;
    }

    .item span.checked {
      text-decoration: line-through;
      color: gray;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.splash-view {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #ffffff 0%, #d1d1d1 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.splash-content {
  text-align: center;
  color: rgb(44, 42, 68);
}

.splash-logo {
  width: 80px;
  height: 80px;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.loading-spinner {
  width: 30px;
  height: 30px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin: 20px auto;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

    .onboarding-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.onboarding-container {
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  max-width: 400px;
  width: 100%;
  padding: 32px;
  text-align: center;
  max-height: 90vh;
  overflow-y: auto;
}

.progress-indicator {
  display: flex;
  justify-content: center;
  margin-bottom: 32px;
}

.progress-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #d1d5db;
  margin: 0 4px;
  transition: background-color 0.3s;
}

.progress-dot.active {
  background: #3b82f6;
}

.onboarding-icon {
  font-size: 4rem;
  margin-bottom: 16px;
}

.onboarding-content h2 {
  font-size: 1.5rem;
  font-weight: bold;
  color: #1f2937;
  margin-bottom: 16px;
}

.onboarding-content p {
  color: #6b7280;
  line-height: 1.6;
  margin-bottom: 32px;
}

.phone-mockup {
  background: #f9fafb;
  border-radius: 12px;
  border: 2px solid #e5e7eb;
  width: 200px;
  height: 120px;
  margin: 0 auto 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.instruction-text {
  background: #f9fafb;
  border-radius: 8px;
  padding: 12px;
  font-size: 0.875rem;
  color: #374151;
  margin-bottom: 24px;
}

.onboarding-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.skip-btn {
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  font-size: 0.875rem;
  transition: color 0.3s;
}

.skip-btn:hover {
  color: #374151;
}

.next-btn {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 12px 32px;
  border-radius: 50px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.3s;
}

.next-btn:hover {
  background: #2563eb;
}

  </style>

      <!-- C√≥digo de AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4528722340355771"
         crossorigin="anonymous"></script>
  
</head>
<body>

  <h1>Lista de la compra by AKOBU</h1>

  <!-- Pantalla de carga/splash -->
<div id="splashView" class="splash-view">
  <div class="splash-content">
    <img src="icono.png" alt="Logo" class="splash-logo">
    <h2>Lista de la compra</h2>
    <p>by AKOBU</p>
    <div class="loading-spinner"></div>
  </div>
</div>

  <div id="authView">
    <h2 id="authTitle">Iniciar sesi√≥n</h2>
    <form id="authForm">
      <input type="text" id="username" placeholder="Usuario" class="input" style="display:none;" />
      <input type="email" id="email" placeholder="Correo electr√≥nico" required class="input"/>
      <input type="password" id="password" placeholder="Contrase√±a" required class="input"/>
      <input type="password" id="confirmPassword" placeholder="Repetir contrase√±a" class="input" style="display:none;" />
      <button type="submit" id="authButton">Entrar</button>
    </form>
    <div class="forgot-password" id="forgotPassword" style="text-align:center; font-size: 14px;margin:10px 0; cursor:pointer; color:#007bff; text-decoration:underline;">¬øOlvidaste tu contrase√±a?</div>
    <div class="toggle" id="toggleAuth">¬øNo tienes cuenta? <span>Reg√≠strate</span></div>
    <p id="authMessage" style="color:red; text-align:center; margin-top:10px;"></p>
  </div>

  <div id="appView">

    <!-- Modal de Onboarding PWA -->
<div id="pwaOnboarding" class="onboarding-overlay" style="display: none;">
  <div class="onboarding-container">
    <!-- Indicador de progreso -->
    <div class="progress-indicator">
      <div class="progress-dot active" data-step="0"></div>
      <div class="progress-dot" data-step="1"></div>
      <div class="progress-dot" data-step="2"></div>
      <div class="progress-dot" data-step="3"></div>
    </div>

    <!-- Contenido -->
    <div class="onboarding-content">
      <div class="onboarding-icon" id="onboardingIcon">üì±</div>
      <h2 id="onboardingTitle">¬°Bienvenido a tu Lista de Compra!</h2>
      <p id="onboardingText">Esta aplicaci√≥n funciona como una app nativa. Te vamos a mostrar c√≥mo instalarla en tu dispositivo.</p>
      
      <!-- Contenedor de instrucciones visuales -->
      <div id="instructionsContainer" style="display: none;">
        <div class="phone-mockup" id="phoneMockup">
          <!-- Aqu√≠ se generar√° el contenido visual -->
        </div>
        <div class="instruction-text" id="instructionText"></div>
      </div>
    </div>

    <!-- Botones -->
    <div class="onboarding-buttons">
      <button id="skipOnboarding" class="skip-btn">Saltar</button>
      <button id="nextOnboarding" class="next-btn">Siguiente</button>
    </div>
  </div>
</div>
    
    
    <div id="modal" class="modal" onclick="closeModal()">
      <img id="modalImage" src="" alt="Vista ampliada" />
    </div>

    <div id="selectorView" class="list-selector">
      <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-button" id="list1Button" onclick="showList('list1View')">Lista 1</div>
      <div class="list-button" id="list2Button" onclick="showList('list2View')">Lista 2</div>
      <div class="list-button" id="list3Button" onclick="showList('list3View')">Lista 3</div>
    </div>

    <div id="list1View" class="view" style="display:none;">
      <div class="top-bar">
        <button class="back-btn" onclick="showList('selectorView')">‚Üê</button>
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown2">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="clearCompletedItems('list1')">Borrar comprados</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-container">
        <h2 class="list-title editable" data-button-id="list1Button" onclick="editListTitle(this)">Lista 1</h2>
        <form class="form" onsubmit="addItem(event, 'list1')">
          <input type="text" placeholder="Nombre del art√≠culo" id="name-list1" required />
          <button type="submit">+</button>
        </form>
        <div id="list1"></div>
      </div>
    </div>

    <div id="list2View" class="view" style="display:none;">
      <div class="top-bar">
        <button class="back-btn" onclick="showList('selectorView')">‚Üê</button>
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown3">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="clearCompletedItems('list2')">Borrar comprados</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-container">
        <h2 class="list-title editable" data-button-id="list2Button" onclick="editListTitle(this)">Lista 2</h2>
        <form class="form" onsubmit="addItem(event, 'list2')">
          <input type="text" placeholder="Nombre del art√≠culo" id="name-list2" required />
          <button type="submit">+</button>
        </form>
        <div id="list2"></div>
      </div>
    </div>

    <div id="list3View" class="view" style="display:none;">
      <div class="top-bar">
        <button class="back-btn" onclick="showList('selectorView')">‚Üê</button>
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown6">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="clearCompletedItems('list3')">Borrar comprados</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-container">
        <h2 class="list-title editable" data-button-id="list3Button" onclick="editListTitle(this)">Lista 3</h2>
        <form class="form" onsubmit="addItem(event, 'list3')">
          <input type="text" placeholder="Nombre del art√≠culo" id="name-list3" required />
          <button type="submit">+</button>
        </form>
        <div id="list3"></div>
      </div>
    </div>

    <div id="articlesView" class="view" style="display:none;">
      <div class="top-bar">
        <button class="back-btn" onclick="showList('selectorView')">‚Üê</button>
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown4">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-container">
        <h2>Todos los Art√≠culos</h2>
        <div id="articlesList"></div>
      </div>
    </div>
    <div id="accountView" class="view" style="display:none;">
      <div class="top-bar">
        <button class="back-btn" onclick="showList('selectorView')">‚Üê</button>
        <div class="menu-container">
          <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
          <div class="menu-dropdown" id="menuDropdown5">
            <div class="menu-item" onclick="showList('articlesView')">Art√≠culos</div>
            <div class="menu-item" onclick="goToSuggestions()">Sugerencias</div>
            <div class="menu-item" onclick="showList('accountView')">Cuenta</div>
            <div class="menu-item" onclick="logout()">Cerrar sesi√≥n</div>
            <div class="menu-item" onclick="goToAbout()">Acerca de</div>
          </div>
        </div>
      </div>
      <div class="list-container">
        <h2>Mi Cuenta</h2>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Correo electr√≥nico:</label>
          <input type="email" id="currentEmail" readonly style="background: #f5f5f5; color: #666;" class="input">
        </div>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Usuario:</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="currentUsername" class="input" style="flex: 1;">
            <button onclick="changeUsername()" style="padding: 10px 16px;height: 40px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">Cambiar</button>
          </div>
        </div>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Cambiar contrase√±a:</label>
          <input type="password" id="currentPassword" placeholder="Contrase√±a actual" class="input" style="margin-bottom: 10px;">
          <input type="password" id="newPassword" placeholder="Nueva contrase√±a" class="input" style="margin-bottom: 10px;">
          <input type="password" id="confirmNewPassword" placeholder="Confirmar nueva contrase√±a" class="input" style="margin-bottom: 10px;">
          <button onclick="changePassword()" style="width: 100%; padding: 10px;height: 40px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">Cambiar Contrase√±a</button>
        </div>
        
        <div id="accountMessage" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
      </div>
    </div>

</div>

  <script>
    
    let currentUser = null;

    const usernameInput = document.getElementById('username');
    const mainTitle = document.querySelector('h1');
    const authView = document.getElementById('authView');
    const appView = document.getElementById('appView');
    const authTitle = document.getElementById('authTitle');
    const authForm = document.getElementById('authForm');
    const authButton = document.getElementById('authButton');
    const toggleAuth = document.getElementById('toggleAuth');
    const authMessage = document.getElementById('authMessage');
    const splashView = document.getElementById('splashView'); 
    const forgotPassword = document.getElementById('forgotPassword');
    let isInitialLoad = true;
    let authMode = 'login';

    // Timeout de seguridad para la pantalla de splash
const splashTimeout = setTimeout(() => {
  console.warn('Timeout de splash - forzando vista de login');
  if (splashView) splashView.style.display = 'none';
  authView.style.display = 'block';
  appView.classList.remove('active');
  isInitialLoad = false;
}, 1500); // 1.5 segundos m√°ximo de espera

// Funci√≥n para limpiar el timeout cuando ya no lo necesites
const clearSplashTimeout = () => {
  if (splashTimeout) {
    clearTimeout(splashTimeout);
  }
};

    toggleAuth.addEventListener('click', () => {
      authMode = authMode === 'login' ? 'register' : 'login';
      authTitle.textContent = authMode === 'login' ? 'Iniciar sesi√≥n' : 'Reg√≠strate';
      authButton.textContent = authMode === 'login' ? 'Entrar' : 'Registrar';
      toggleAuth.innerHTML = authMode === 'login' ? '¬øNo tienes cuenta? <span>Reg√≠strate</span>' : '¬øYa tienes cuenta? <span>Inicia sesi√≥n</span>';
      forgotPassword.style.display = authMode === 'login' ? 'block' : 'none';
      authMessage.textContent = '';

     const confirmPasswordInput = document.getElementById('confirmPassword');
if (authMode === 'register') {
  usernameInput.style.display = 'block';
  usernameInput.required = true;
  confirmPasswordInput.style.display = 'block';
  confirmPasswordInput.required = true;
} else {
  usernameInput.style.display = 'none';
  usernameInput.required = false;
  confirmPasswordInput.style.display = 'none';
  confirmPasswordInput.required = false;
}
    });

    forgotPassword.addEventListener('click', () => {
  const email = document.getElementById('email').value;
  
  if (!email) {
    document.getElementById('authMessage').textContent = 'Por favor, introduce tu correo electr√≥nico';
    return;
  }
  
  // Enviar email de recuperaci√≥n
  auth.sendPasswordResetEmail(email)
    .then(() => {
      document.getElementById('authMessage').style.color = 'green';
      document.getElementById('authMessage').textContent = 'Se ha enviado un correo de recuperaci√≥n. Revisa tu bandeja de entrada.';
    })
    .catch((error) => {
      document.getElementById('authMessage').style.color = 'red';
      document.getElementById('authMessage').textContent = 'Error: ' + error.message;
    });
});
    
    authForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const username = document.getElementById("username").value.trim();

  if (authMode === "register") {
    if (password !== confirmPassword) {
      authMessage.textContent = "Las contrase√±as no coinciden.";
      return;
    }
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      await db.collection("users").doc(user.uid).set({
  username: username,
  email: email,
  lists: {
    list1: [],
    list2: [],
    list3: []
  },
  itemLibrary: {} // Nueva biblioteca de art√≠culos del usuario
  hasSeenOnboarding: false
});

      currentUser = user;
      mainTitle.textContent = `Lista de la compra de ${username}`;
      authView.style.display = 'none';
    // üëà Mostrar onboarding en lugar de ir directo a la app
    showOnboarding();
    appView.classList.add('active');

} catch (error) {
      // Mostrar mensajes m√°s amigables seg√∫n el tipo de error
      if (error.code === 'auth/weak-password') {
        authMessage.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
      } else if (error.code === 'auth/email-already-in-use') {
        authMessage.textContent = 'Ya existe una cuenta con este correo electr√≥nico';
      } else if (error.code === 'auth/invalid-email') {
        authMessage.textContent = 'El formato del correo electr√≥nico no es v√°lido';
      } else if (error.code === 'auth/operation-not-allowed') {
        authMessage.textContent = 'El registro con email est√° deshabilitado';
      } else {
        authMessage.textContent = 'Error al crear la cuenta. Int√©ntalo de nuevo';
      }
    }
  } else {
    // LOGIN
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;

const doc = await db.collection("users").doc(user.uid).get();
const userData = doc.data();

currentUser = user;
mainTitle.textContent = `Lista de la compra de ${userData.username}`;

// Cargar nombres de listas guardados
if (userData.list1Name) {
  document.querySelector('[data-button-id="list1Button"]').textContent = userData.list1Name;
  document.getElementById('list1Button').textContent = userData.list1Name;
}
if (userData.list2Name) {
  document.querySelector('[data-button-id="list2Button"]').textContent = userData.list2Name;
  document.getElementById('list2Button').textContent = userData.list2Name;
}
if (userData.list3Name) {
  document.querySelector('[data-button-id="list3Button"]').textContent = userData.list3Name;
  document.getElementById('list3Button').textContent = userData.list3Name;
}

authView.style.display = 'none';
appView.classList.add('active');
loadLists();
      // Aqu√≠ puedes cargar listas desde Firestore m√°s adelante.
    } catch (error) {
      // Mostrar mensajes m√°s amigables seg√∫n el tipo de error
      if (error.code === 'auth/invalid-credential' || 
          error.code === 'auth/user-not-found' || 
          error.code === 'auth/wrong-password') {
        authMessage.textContent = 'Usuario y/o contrase√±a incorrecta';
      } else if (error.code === 'auth/invalid-email') {
        authMessage.textContent = 'El formato del correo electr√≥nico no es v√°lido';
      } else if (error.code === 'auth/user-disabled') {
        authMessage.textContent = 'Esta cuenta ha sido deshabilitada';
      } else if (error.code === 'auth/too-many-requests') {
        authMessage.textContent = 'Demasiados intentos fallidos. Int√©ntalo m√°s tarde';
      } else {
        authMessage.textContent = 'Error al iniciar sesi√≥n. Int√©ntalo de nuevo';
      }
    }
  }
});



function logout() {
    // Cerrar sesi√≥n en Firebase 
    auth.signOut().then(() => {
        console.log('Sesi√≥n cerrada correctamente');
        // El resto del c√≥digo se ejecutar√° autom√°ticamente por onAuthStateChanged
    }).catch((error) => {
        console.error('Error al cerrar sesi√≥n:', error);
    });
    
    // Opcional: puedes mantener esto para feedback inmediato en la UI
    currentUser = null;
      // Reset nombres de listas
    document.querySelector('[data-button-id="list1Button"]').textContent = 'Lista 1';
    document.getElementById('list1Button').textContent = 'Lista 1';
    document.querySelector('[data-button-id="list2Button"]').textContent = 'Lista 2';
    document.getElementById('list2Button').textContent = 'Lista 2';
    document.querySelector('[data-button-id="list3Button"]').textContent = 'Lista 3';
    document.getElementById('list3Button').textContent = 'Lista 3';
    
    appView.classList.remove('active');
    authView.style.display = 'block';
    authForm.reset();
    mainTitle.textContent = 'Lista de la compra by AKOBU';
}

function showList(viewId) {
  closeAllMenus(); // Cerrar todos los men√∫s al cambiar de vista
  document.getElementById('selectorView').style.display = 'none';
  document.getElementById('list1View').style.display = 'none';
  document.getElementById('list2View').style.display = 'none';
  document.getElementById('list3View').style.display = 'none';
  document.getElementById('articlesView').style.display = 'none';
  document.getElementById('accountView').style.display = 'none';
  if (viewId === 'selectorView') {
    document.getElementById('selectorView').style.display = 'flex';
  } else {
    document.getElementById(viewId).style.display = 'block';
  }
  
  if (viewId === 'articlesView') {
    loadArticles();
  } else if (viewId === 'list1View' || viewId === 'list2View' || viewId === 'list3View') {
    loadLists();
  } else if (viewId === 'accountView') {
    loadAccountView();
  }
}

    async function loadLists() {
  if (!currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const data = userData.lists || { list1: [], list2: [], list3: [] };
    
['list1', 'list2', 'list3'].forEach(listId => {
  const container = document.getElementById(listId);
  container.innerHTML = '';
  const orderedList = reorderList(data[listId] || []);
  orderedList.forEach((item, index) => {
  const el = document.createElement('div');
  el.className = 'item';
  const img = document.createElement('img');
  img.src = item.img || 'https://cdn-icons-png.flaticon.com/512/685/685655.png';
  img.className = item.img ? '' : 'default-img';
  img.onclick = () => {
    if (!item.img) {
      selectImage(index, listId);
    } else {
      document.getElementById('modalImage').src = item.img;
      document.getElementById('modal').style.display = 'flex';
    }
  };
        const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.checked = item.checked;
checkbox.onchange = async () => {
  item.checked = checkbox.checked;
  
  // Reordenar la lista: no marcados primero, marcados al final
  const reorderedList = data[listId].sort((a, b) => {
    if (a.checked === b.checked) return 0;
    return a.checked ? 1 : -1; // Los marcados (true) van al final
  });
  
  await saveItemToFirebase(listId, reorderedList);
  loadLists(); // Recargar para mostrar el nuevo orden
};
        const span = document.createElement('span');
        span.textContent = item.name;
        span.className = 'editable' + (item.checked ? ' checked' : '');
        el.append(checkbox, img, span);
        container.appendChild(el);
      });
    });
  } catch (error) {
    console.error("Error al cargar listas:", error);
  }
}

async function saveItemToFirebase(listId, items) {
  if (!currentUser) return;
  try {
    await db.collection("users").doc(currentUser.uid).update({
      [`lists.${listId}`]: items
    });
  } catch (error) {
    console.error("Error al guardar en Firebase:", error);
  }
}

function reorderList(list) {
  // Separar elementos marcados y no marcados
  const unchecked = list.filter(item => !item.checked);
  const checked = list.filter(item => item.checked);
  
  // Devolver primero los no marcados, luego los marcados
  return [...unchecked, ...checked];
}

async function addItem(e, listId) {
  e.preventDefault();
  const input = document.getElementById(`name-${listId}`);
  const name = input.value.trim();
  if (!name || !currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const currentList = userData.lists[listId] || [];
    const itemLibrary = userData.itemLibrary || {};
    
    // Crear el nuevo item
    const newItem = { name, checked: false };
    
    // Si el art√≠culo ya existe en la biblioteca, usar su imagen
const normalizedName = name.toLowerCase().trim();
if (itemLibrary[normalizedName] && itemLibrary[normalizedName].img) {
  newItem.img = itemLibrary[normalizedName].img;
  console.log('Usando imagen guardada para:', name);
}

// Siempre guardar el art√≠culo en la biblioteca (sin imagen si no la tiene)
itemLibrary[normalizedName] = {
  name: name,
  img: newItem.img || null
};

currentList.unshift(newItem);
    
    // Reordenar la lista antes de guardar
const reorderedList = reorderList(currentList);

console.log('Guardando itemLibrary:', itemLibrary);
await db.collection("users").doc(currentUser.uid).update({
  [`lists.${listId}`]: reorderedList,
  itemLibrary: itemLibrary
});
console.log('Guardado exitoso');  

    input.value = '';
    loadLists();
  } catch (error) {
    console.error("Error al a√±adir art√≠culo:", error);
  }
}

    // Funci√≥n para comprimir im√°genes
async function compressImage(file, maxSizeKB = 100, quality = 0.8) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Calcular nuevas dimensiones manteniendo la proporci√≥n
      const maxWidth = 800;
      const maxHeight = 600;
      let { width, height } = img;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (width * maxHeight) / height;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Dibujar la imagen redimensionada
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convertir a blob y ajustar calidad si es necesario
      const tryCompress = (currentQuality) => {
        canvas.toBlob((blob) => {
          if (blob.size <= maxSizeKB * 1024 || currentQuality <= 0.1) {
            resolve(blob);
          } else {
            // Si a√∫n es muy grande, reducir m√°s la calidad
            tryCompress(currentQuality - 0.1);
          }
        }, 'image/jpeg', currentQuality);
      };
      
      tryCompress(quality);
    };
    
    img.src = URL.createObjectURL(file);
  });
}

async function selectImage(itemIndex, listId) {
  console.log('Seleccionando imagen para item:', itemIndex, 'en lista:', listId);
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  <!--  input.capture = 'environment'; -->
input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Archivo seleccionado:', file.name, 'Tama√±o original:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    try {
      // Comprimir la imagen antes de subirla
      const compressedFile = await compressImage(file, 50); // 50KB m√°ximo
      console.log('Imagen comprimida:', (compressedFile.size / 1024).toFixed(2) + 'KB');
      
      // Crear una referencia √∫nica para la imagen
      const imageRef = storage.ref(`images/${currentUser.uid}/${listId}/${itemIndex}_${Date.now()}`);
      
      // Subir la imagen comprimida a Firebase Storage
      console.log('Subiendo imagen comprimida a Storage...');
      const snapshot = await imageRef.put(compressedFile);
      
      // Obtener la URL de descarga
      const downloadURL = await snapshot.ref.getDownloadURL();
      console.log('URL de imagen obtenida:', downloadURL);
      
      // Obtener la lista actual de Firebase
      const doc = await db.collection("users").doc(currentUser.uid).get();
      const userData = doc.data();
      const currentList = userData.lists[listId] || [];
      const itemLibrary = userData.itemLibrary || {};
      
      console.log('Lista actual:', currentList);
      console.log('Item a actualizar:', currentList[itemIndex]);
      
      // Actualizar el item espec√≠fico usando el √≠ndice
      if (currentList[itemIndex]) {
        currentList[itemIndex].img = downloadURL;
        
        // Guardar tambi√©n en la biblioteca del usuario
        const normalizedName = currentList[itemIndex].name.toLowerCase().trim();
        itemLibrary[normalizedName] = {
          name: currentList[itemIndex].name,
          img: downloadURL
        };
        
        console.log('Item actualizado con URL de imagen y guardado en biblioteca');
        
        // Guardar tanto la lista como la biblioteca
        await db.collection("users").doc(currentUser.uid).update({
          [`lists.${listId}`]: currentList,
          itemLibrary: itemLibrary
        });
        
        console.log('Guardado en Firebase');
        
        // Recargar las listas para mostrar la nueva imagen
        loadLists();
      }
    } catch (error) {
      console.error("Error al guardar imagen:", error);
    }
  };
  input.click();
}

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

async function editListTitle(element) {
  const currentTitle = element.textContent;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentTitle;
  input.style.fontSize = '24px';
  input.style.width = '100%';

  input.onblur = async () => {
    const newTitle = input.value.trim() || currentTitle;
    element.textContent = newTitle;

    const buttonId = element.getAttribute('data-button-id');
    const button = document.getElementById(buttonId);
    if (button) button.textContent = newTitle;

    // Guardar en Firebase
    if (currentUser && newTitle !== currentTitle) {
      try {
        const listKey = buttonId === 'list1Button' ? 'list1Name' : 
                buttonId === 'list2Button' ? 'list2Name' : 
                'list3Name';
        await db.collection("users").doc(currentUser.uid).update({
          [listKey]: newTitle
        });
      } catch (error) {
        console.error("Error al guardar el nombre de la lista:", error);
      }
    }

    // Volver a activar la edici√≥n si se hace clic de nuevo
    element.onclick = () => editListTitle(element);
  };

  element.textContent = '';
  element.onclick = null; // quitar el evento mientras se edita
  element.appendChild(input);
  input.focus();
}

function toggleMenu(menuId) {
  // Si no se especifica un ID, usar el men√∫ principal de la vista actual
  if (!menuId) {
    const currentView = getCurrentView();
    if (currentView === 'selectorView') menuId = 'menuDropdown';
    else if (currentView === 'list1View') menuId = 'menuDropdown2';
    else if (currentView === 'list2View') menuId = 'menuDropdown3';
    else if (currentView === 'list3View') menuId = 'menuDropdown6';
    else if (currentView === 'articlesView') menuId = 'menuDropdown4';
    else if (currentView === 'accountView') menuId = 'menuDropdown5';
  }
  
  const targetDropdown = document.getElementById(menuId);
  if (targetDropdown) {
    targetDropdown.classList.toggle('show');
  }
}

function getCurrentView() {
  if (document.getElementById('selectorView').style.display !== 'none') return 'selectorView';
  if (document.getElementById('list1View').style.display === 'block') return 'list1View';
  if (document.getElementById('list2View').style.display === 'block') return 'list2View';
  if (document.getElementById('list3View').style.display === 'block') return 'list3View';
  if (document.getElementById('articlesView').style.display === 'block') return 'articlesView';
  if (document.getElementById('accountView').style.display === 'block') return 'accountView';
  return 'selectorView';
}

function closeAllMenus() {
  const dropdowns = document.querySelectorAll('.menu-dropdown');
  dropdowns.forEach(dropdown => {
    dropdown.classList.remove('show');
  });
}

// Cerrar el men√∫ si se hace clic fuera de √©l
document.addEventListener('click', function(event) {
  const menuContainers = document.querySelectorAll('.menu-container');
  let clickedInsideMenu = false;
  
  menuContainers.forEach(container => {
    if (container.contains(event.target)) {
      clickedInsideMenu = true;
    }
  });
  
  if (!clickedInsideMenu) {
    const dropdowns = document.querySelectorAll('.menu-dropdown');
    dropdowns.forEach(dropdown => {
      dropdown.classList.remove('show');
    });
  }
});

    document.addEventListener('DOMContentLoaded', function() {
    // Detectar si es m√≥vil
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    if (isMobile) {
        // En m√≥vil, cerrar men√∫s en varios eventos
        const externalLinks = document.querySelectorAll('a[href$=".html"], a[href*="/"]');
        
        externalLinks.forEach(link => {
            // Usar touchstart en lugar de click para m√≥viles
            link.addEventListener('touchstart', function() {
                closeAllMenus();
            });
            
            link.addEventListener('click', function() {
                closeAllMenus();
            });
        });
        
        // Tambi√©n cerrar cuando se pierde el foco de la ventana
        window.addEventListener('pagehide', function() {
            closeAllMenus();
        });
        
        window.addEventListener('blur', function() {
            closeAllMenus();
        });
    } else {
        // En PC, usar la soluci√≥n original
        const externalLinks = document.querySelectorAll('a[href$=".html"], a[href*="/"]');
        externalLinks.forEach(link => {
            link.addEventListener('click', function() {
                closeAllMenus();
            });
        });
        
        window.addEventListener('beforeunload', function() {
            closeAllMenus();
        });
    }
});

async function loadArticles() {
  if (!currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const itemLibrary = userData.itemLibrary || {};

        console.log('userData:', userData);
    console.log('itemLibrary:', itemLibrary);
    
    const container = document.getElementById('articlesList');
    container.innerHTML = '';
    
    // Convertir el objeto itemLibrary en array y ordenar alfab√©ticamente
    const articles = Object.values(itemLibrary).sort((a, b) => a.name.localeCompare(b.name));
    
    if (articles.length === 0) {
      container.innerHTML = '<p style="text-align: center; color: #888; font-style: italic;">No tienes art√≠culos guardados a√∫n.</p>';
      return;
    }
    
articles.forEach(article => {
  const el = document.createElement('div');
  el.className = 'item';
  
  const img = document.createElement('img');
  img.src = article.img || 'https://cdn-icons-png.flaticon.com/512/685/685655.png';
  img.className = article.img ? '' : 'default-img';
  img.onclick = () => {
    if (!article.img) {
      selectImageForArticle(article.name);
    } else {
      document.getElementById('modalImage').src = article.img;
      document.getElementById('modal').style.display = 'flex';
    }
  };
  
  const span = document.createElement('span');
  span.textContent = article.name;
  span.className = 'editable';
  
  // Crear el men√∫ de edici√≥n
  const menuContainer = document.createElement('div');
  menuContainer.className = 'menu-container';
  menuContainer.style.marginLeft = 'auto';
  
  const editBtn = document.createElement('button');
  editBtn.innerHTML = '‚úé';
  editBtn.className = 'menu-btn';
  editBtn.style.minWidth = '35px';
  editBtn.style.height = '35px';
  editBtn.style.fontSize = '16px';
  editBtn.onclick = (e) => {
    e.stopPropagation();
    toggleArticleMenu(menuContainer);
  };
  
  const dropdown = document.createElement('div');
  dropdown.className = 'menu-dropdown';
  
  const changePhotoItem = document.createElement('div');
  changePhotoItem.className = 'menu-item';
  changePhotoItem.textContent = 'Cambiar foto';
  changePhotoItem.onclick = () => {
    selectImageForArticle(article.name);
    closeAllMenus();
  };
  
  const editNameItem = document.createElement('div');
  editNameItem.className = 'menu-item';
  editNameItem.textContent = 'Editar nombre';
  editNameItem.onclick = () => {
    editArticleName(article.name);
    closeAllMenus();
  };
  
  const deleteItem = document.createElement('div');
  deleteItem.className = 'menu-item';
  deleteItem.textContent = 'Borrar art√≠culo';
  deleteItem.onclick = () => {
    deleteArticle(article.name);
    closeAllMenus();
  };
  
  dropdown.append(changePhotoItem, editNameItem, deleteItem);
  menuContainer.append(editBtn, dropdown);
  
  el.append(img, span, menuContainer);
  container.appendChild(el);
});
    
     console.log('Art√≠culos cargados:', articles.length);
  } catch (error) {
    console.error("Error al cargar art√≠culos:", error);
  }
}

function toggleArticleMenu(menuContainer) {
  const dropdown = menuContainer.querySelector('.menu-dropdown');
  
  // Cerrar otros men√∫s primero
  document.querySelectorAll('.menu-dropdown').forEach(otherDropdown => {
    if (otherDropdown !== dropdown) {
      otherDropdown.classList.remove('show');
    }
  });
  
  dropdown.classList.toggle('show');
}

async function editArticleName(oldName) {
  const newName = prompt('Nuevo nombre del art√≠culo:', oldName);
  if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const itemLibrary = userData.itemLibrary || {};
    const lists = userData.lists || { list1: [], list2: [],list3: [] };
    
    const oldNormalizedName = oldName.toLowerCase().trim();
    const newNormalizedName = newName.trim().toLowerCase();
    
    // Verificar si el nuevo nombre ya existe (y no es el mismo art√≠culo)
    if (itemLibrary[newNormalizedName] && newNormalizedName !== oldNormalizedName) {
      alert(`Ya existe un art√≠culo con el nombre "${newName.trim()}". Por favor, elige otro nombre.`);
      return;
    }
    
    // Actualizar en la biblioteca
    if (itemLibrary[oldNormalizedName]) {
      const articleData = itemLibrary[oldNormalizedName];
      itemLibrary[newNormalizedName] = {
        name: newName.trim(),
        img: articleData.img
      };
      delete itemLibrary[oldNormalizedName];
    }
    
    // Actualizar en todas las listas que contengan este art√≠culo
    Object.keys(lists).forEach(listKey => {
      lists[listKey].forEach(item => {
        if (item.name.toLowerCase().trim() === oldNormalizedName) {
          item.name = newName.trim();
        }
      });
    });
    
    // Guardar cambios en Firebase
    await db.collection("users").doc(currentUser.uid).update({
      itemLibrary: itemLibrary,
      lists: lists
    });
    
    console.log('Nombre actualizado correctamente');
    loadArticles();
    
    // Si estamos viendo alguna lista, recargarla tambi√©n
    if (document.getElementById('list1View').style.display === 'block' || 
        document.getElementById('list2View').style.display === 'block' || 
        document.getElementById('list3View').style.display === 'block') {
      loadLists();
    }
    
  } catch (error) {
    console.error("Error al editar nombre del art√≠culo:", error);
    alert("Error al cambiar el nombre del art√≠culo");
  }
}

async function deleteArticle(articleName) {
  if (!confirm(`¬øEst√°s seguro de que quieres borrar "${articleName}"?\n\nEsto tambi√©n lo eliminar√° de todas las listas de la compra.`)) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const itemLibrary = userData.itemLibrary || {};
    const lists = userData.lists || { list1: [], list2: [],list3: [] };
    
    const normalizedName = articleName.toLowerCase().trim();
    
    // Obtener la URL de la imagen antes de eliminar el art√≠culo
    const imageUrl = itemLibrary[normalizedName]?.img;
    
    // Si el art√≠culo tiene imagen, eliminarla de Storage
    if (imageUrl) {
      try {
        const imageRef = storage.refFromURL(imageUrl);
        await imageRef.delete();
        console.log('Imagen eliminada de Storage:', imageUrl);
      } catch (imageError) {
        console.warn('Error al eliminar imagen de Storage:', imageError);
        // Continuar aunque falle el borrado de la imagen
      }
    }
    
    // Eliminar de la biblioteca
    delete itemLibrary[normalizedName];
    
    // Eliminar de todas las listas
    Object.keys(lists).forEach(listKey => {
      lists[listKey] = lists[listKey].filter(item => 
        item.name.toLowerCase().trim() !== normalizedName
      );
    });
    
    // Guardar cambios en Firebase
    await db.collection("users").doc(currentUser.uid).update({
      itemLibrary: itemLibrary,
      lists: lists
    });
    
    console.log('Art√≠culo eliminado correctamente');
    loadArticles();
    
    // Si estamos viendo alguna lista, recargarla tambi√©n
    if (document.getElementById('list1View').style.display === 'block' || 
        document.getElementById('list2View').style.display === 'block' || 
        document.getElementById('list3View').style.display === 'block') {
      loadLists();
    }
    
  } catch (error) {
    console.error("Error al eliminar art√≠culo:", error);
    alert("Error al eliminar el art√≠culo");
  }
}

async function selectImageForArticle(articleName) {
  console.log('Seleccionando imagen para art√≠culo:', articleName);
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  <!--  input.capture = 'environment'; -->
input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Archivo seleccionado:', file.name, 'Tama√±o original:', (file.size / 1024 / 1024).toFixed(2) + 'MB');
    
    try {
      // Comprimir la imagen antes de subirla
      const compressedFile = await compressImage(file, 50); // 50KB m√°ximo
      console.log('Imagen comprimida:', (compressedFile.size / 1024).toFixed(2) + 'KB');
      
      // Crear una referencia √∫nica para la imagen
      const imageRef = storage.ref(`images/${currentUser.uid}/articles/${articleName}_${Date.now()}`);
      
      // Subir la imagen comprimida a Firebase Storage
      console.log('Subiendo imagen comprimida a Storage...');
      const snapshot = await imageRef.put(compressedFile);
      
      // Obtener la URL de descarga
      const downloadURL = await snapshot.ref.getDownloadURL();
      console.log('URL de imagen obtenida:', downloadURL);
      
      // Obtener los datos actuales del usuario
      const doc = await db.collection("users").doc(currentUser.uid).get();
      const userData = doc.data();
      const itemLibrary = userData.itemLibrary || {};
      
      // Actualizar la imagen del art√≠culo en la biblioteca
      const normalizedName = articleName.toLowerCase().trim();
      itemLibrary[normalizedName] = itemLibrary[normalizedName] || { name: articleName };
      itemLibrary[normalizedName].img = downloadURL;

      // Obtener las listas y actualizar todas las que contengan este art√≠culo
      const lists = userData.lists || { list1: [], list2: [], list3: []  };

      Object.keys(lists).forEach(listKey => {
        lists[listKey].forEach(item => {
          if (item.name.toLowerCase().trim() === normalizedName) {
            item.img = downloadURL;
            console.log('Actualizando imagen en lista:', listKey, 'para art√≠culo:', item.name);
          }
        });
      });

      console.log('Art√≠culo actualizado con nueva imagen');

      // Guardar tanto la biblioteca como las listas actualizadas
      await db.collection("users").doc(currentUser.uid).update({
        itemLibrary: itemLibrary,
        lists: lists
      });
        
      console.log('Guardado en Firebase');
      
      // Recargar tanto la vista de art√≠culos como las listas si estamos en una vista de lista
      loadArticles();
      if (document.getElementById('list1View').style.display === 'block' || 
          document.getElementById('list2View').style.display === 'block' || 
          document.getElementById('list3View').style.display === 'block') {
        loadLists();
      }
    } catch (error) {
      console.error("Error al guardar imagen del art√≠culo:", error);
    }
  };
  input.click();
}

async function clearCompletedItems(listId) {
  if (!currentUser) return;
  
  // Cerrar el men√∫ primero
  closeAllMenus();
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    const currentList = userData.lists[listId] || [];
    
    // Contar cu√°ntos art√≠culos se van a borrar
    const completedItems = currentList.filter(item => item.checked);
    
    if (completedItems.length === 0) {
      alert('No hay art√≠culos comprados para borrar.');
      return;
    }
    
    if (!confirm(`¬øEst√°s seguro de que quieres borrar ${completedItems.length} art√≠culo(s) comprado(s)?`)) {
      return;
    }
    
    // Filtrar solo los art√≠culos no marcados (borrar los marcados)
    const remainingItems = currentList.filter(item => !item.checked);
    
    // Guardar la lista actualizada en Firebase
    await db.collection("users").doc(currentUser.uid).update({
      [`lists.${listId}`]: remainingItems
    });
    
    console.log(`${completedItems.length} art√≠culos comprados eliminados de ${listId}`);
    loadLists();
    
  } catch (error) {
    console.error("Error al borrar art√≠culos comprados:", error);
    alert("Error al borrar los art√≠culos comprados");
  }
}

// Detector de estado de autenticaci√≥n con splash screen
auth.onAuthStateChanged(async (user) => {
  console.log('Estado de autenticaci√≥n cambi√≥:', user ? 'Logueado' : 'No logueado');
  
  // Funci√≥n para ocultar splash y mostrar la vista correcta
const showFinalView = () => {
  clearSplashTimeout(); // Limpiar timeout de seguridad
  if (splashView) splashView.style.display = 'none';
  
  if (user) {
    // Usuario logueado
    authView.style.display = 'none';
    appView.classList.add('active');
    showList('selectorView');
  } else {
    // No hay usuario  
    authView.style.display = 'block';
    appView.classList.remove('active');
  }
};
  
  if (user) {
    // Usuario est√° logueado
    console.log('Usuario detectado:', user.email);
    currentUser = user;
    
    try {
      // Cargar datos del usuario
      const doc = await db.collection("users").doc(user.uid).get();
      const userData = doc.data();
      
      // Actualizar el t√≠tulo con el nombre del usuario
      mainTitle.textContent = `Lista de la compra de ${userData.username}`;
      mainTitle.style.display = 'block';
      
      // PRIMERO: Resetear TODOS los nombres a valores por defecto
document.querySelector('[data-button-id="list1Button"]').textContent = 'Lista 1';
document.getElementById('list1Button').textContent = 'Lista 1';
document.querySelector('[data-button-id="list2Button"]').textContent = 'Lista 2';
document.getElementById('list2Button').textContent = 'Lista 2';
document.querySelector('[data-button-id="list3Button"]').textContent = 'Lista 3';
document.getElementById('list3Button').textContent = 'Lista 3';

// DESPU√âS: Cargar nombres personalizados si existen
      
      if (userData.list1Name) {
        document.querySelector('[data-button-id="list1Button"]').textContent = userData.list1Name;
        document.getElementById('list1Button').textContent = userData.list1Name;
      }
      if (userData.list2Name) {
        document.querySelector('[data-button-id="list2Button"]').textContent = userData.list2Name;
        document.getElementById('list2Button').textContent = userData.list2Name;
      }
       if (userData.list3Name) {
        document.querySelector('[data-button-id="list3Button"]').textContent = userData.list3Name;
        document.getElementById('list3Button').textContent = userData.list3Name;
      }
      
      // Mostrar vista despu√©s del delay solo en carga inicial
      if (isInitialLoad) {
        setTimeout(() => {
          showFinalView();
          isInitialLoad = false;
        }, 1500); // 1.5 segundos de splash
      } else {
        showFinalView(); // Sin delay si no es carga inicial
      }
      
    } catch (error) {
      console.error("Error al cargar datos del usuario:", error);
      auth.signOut(); // Si hay error, hacer logout
    }
  } else {
    // No hay usuario logueado
    console.log('No hay usuario logueado');
    currentUser = null;
    mainTitle.textContent = 'Lista de la compra by AKOBU';
    mainTitle.style.display = 'block';
    
    // Mostrar vista despu√©s del delay solo en carga inicial
    if (isInitialLoad) {
      setTimeout(() => {
        showFinalView();
        isInitialLoad = false;
      }, 1500); // 1.5 segundos de splash
    } else {
      showFinalView(); // Sin delay si no es carga inicial
    }
  }
});

async function changeUsername() {
  const newUsername = document.getElementById('currentUsername').value.trim();
  if (!newUsername || !currentUser) return;
  
  try {
    // Actualizar el nombre de usuario en Firestore
    await db.collection("users").doc(currentUser.uid).update({
      username: newUsername
    });
    
    // Actualizar el t√≠tulo de la aplicaci√≥n
    mainTitle.textContent = `Lista de la compra de ${newUsername}`;
    
    // Mostrar mensaje de √©xito
    showAccountMessage('Usuario cambiado correctamente', 'success');
    
  } catch (error) {
    console.error("Error al cambiar usuario:", error);
    showAccountMessage('Error al cambiar el usuario', 'error');
  }
}

async function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmNewPassword = document.getElementById('confirmNewPassword').value;
  
  if (!currentPassword || !newPassword || !confirmNewPassword) {
    showAccountMessage('Por favor, completa todos los campos', 'error');
    return;
  }
  
  if (newPassword !== confirmNewPassword) {
    showAccountMessage('Las contrase√±as nuevas no coinciden', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showAccountMessage('La nueva contrase√±a debe tener al menos 6 caracteres', 'error');
    return;
  }
  
  try {
    // Reautenticar al usuario con la contrase√±a actual
    const credential = firebase.auth.EmailAuthProvider.credential(
      currentUser.email,
      currentPassword
    );
    await currentUser.reauthenticateWithCredential(credential);
    
    // Cambiar la contrase√±a
    await currentUser.updatePassword(newPassword);
    
    // Limpiar los campos
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    
    showAccountMessage('Contrase√±a cambiada correctamente', 'success');
    
  } catch (error) {
    console.error("Error al cambiar contrase√±a:", error);
    if (error.code === 'auth/wrong-password') {
      showAccountMessage('La contrase√±a actual es incorrecta', 'error');
    } else if (error.code === 'auth/weak-password') {
      showAccountMessage('La nueva contrase√±a es muy d√©bil', 'error');
    } else {
      showAccountMessage('Error al cambiar la contrase√±a', 'error');
    }
  }
}

function showAccountMessage(message, type) {
  const messageDiv = document.getElementById('accountMessage');
  messageDiv.textContent = message;
  messageDiv.style.display = 'block';
  
  if (type === 'success') {
    messageDiv.style.backgroundColor = '#d4edda';
    messageDiv.style.color = '#155724';
    messageDiv.style.border = '1px solid #c3e6cb';
  } else {
    messageDiv.style.backgroundColor = '#f8d7da';
    messageDiv.style.color = '#721c24';
    messageDiv.style.border = '1px solid #f5c6cb';
  }
  
  // Ocultar el mensaje despu√©s de 5 segundos
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}

async function loadAccountView() {
  if (!currentUser) return;
  
  try {
    const doc = await db.collection("users").doc(currentUser.uid).get();
    const userData = doc.data();
    
    // Cargar el email (solo lectura)
    document.getElementById('currentEmail').value = currentUser.email;
    
    // Cargar el nombre de usuario actual
    document.getElementById('currentUsername').value = userData.username || '';
    
  } catch (error) {
    console.error("Error al cargar datos de la cuenta:", error);
  }
}

// Inicializaci√≥n - mostrar splash al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  if (splashView) {
    splashView.style.display = 'flex';
  }
  authView.style.display = 'none';
  appView.classList.remove('active');
});

   function goToAbout() {
    const user = firebase.auth().currentUser;
    if (user) {
        const username = user.displayName || user.email || 'Usuario';
        window.location.href = `about.html?user=${encodeURIComponent(username)}`;
    } else {
        window.location.href = 'about.html';
    }
}

document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        console.log('App visible again - refreshing lists');
        loadLists();
    }
});

function goToSuggestions() {
    let username = 'Usuario';
    
    // Intentar obtener el nombre del usuario actual
    if (currentUser && currentUser.displayName) {
        username = currentUser.displayName;
    } else if (currentUser && currentUser.email) {
        username = currentUser.email.split('@')[0]; // Usar parte antes del @
    }
    
    window.location.href = `suggestions.html?user=${encodeURIComponent(username)}`;
}

    
// Registro y gesti√≥n del Service Worker

let updateAvailable = false;

// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker registrado correctamente:', registration.scope);
        
        // Verificar actualizaciones
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('Nueva versi√≥n del Service Worker encontrada');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                // Hay una nueva versi√≥n disponible
                updateAvailable = true;
                showUpdateNotification();
              } else {
                // Primera instalaci√≥n
                console.log('Service Worker instalado por primera vez');
              }
            }
          });
        });
      })
      .catch(error => {
        console.error('Error al registrar Service Worker:', error);
      });
  });

  // Escuchar cambios en el Service Worker
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (updateAvailable) {
      window.location.reload();
    }
  });
}

// Funci√≥n para mostrar notificaci√≥n de actualizaci√≥n
function showUpdateNotification() {
  // Opci√≥n 1: Alerta simple
  if (confirm('¬°Hay una nueva versi√≥n disponible! ¬øQuieres actualizar ahora?')) {
    updateApp();
  }
  
  // Opci√≥n 2: Notificaci√≥n personalizada (comenta la alerta de arriba si usas esto)
  /*
  const notification = document.createElement('div');
  notification.id = 'update-notification';
  notification.innerHTML = `
    <div style="
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      font-family: Arial, sans-serif;
    ">
      <p style="margin: 0 0 10px 0;">¬°Nueva versi√≥n disponible!</p>
      <button onclick="updateApp()" style="
        background: white;
        color: #4CAF50;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      ">Actualizar</button>
      <button onclick="dismissUpdate()" style="
        background: transparent;
        color: white;
        border: 1px solid white;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
      ">M√°s tarde</button>
    </div>
  `;
  document.body.appendChild(notification);
  */
}

// Funci√≥n para actualizar la app
function updateApp() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(registration => {
      if (registration && registration.waiting) {
        // Enviar mensaje al service worker para que se active
        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
      }
    });
  }
}

// Funci√≥n para cerrar la notificaci√≥n (si usas la opci√≥n 2)
function dismissUpdate() {
  const notification = document.getElementById('update-notification');
  if (notification) {
    notification.remove();
  }
}

// Variables para onboarding
let currentOnboardingStep = 0;
let isNewUser = false;
let isIOS = false;
let isAndroid = false;

// Detectar dispositivo
function detectDevice() {
  const userAgent = navigator.userAgent.toLowerCase();
  isIOS = /iphone|ipad|ipod/.test(userAgent);
  isAndroid = /android/.test(userAgent);
}

// Inicializar onboarding
function initOnboarding() {
  detectDevice();
  setupOnboardingEvents();
}

// Configurar eventos del onboarding
function setupOnboardingEvents() {
  document.getElementById('nextOnboarding').addEventListener('click', nextOnboardingStep);
  document.getElementById('skipOnboarding').addEventListener('click', closeOnboarding);
}

// Datos de los pasos
function getOnboardingSteps() {
  return [
    {
      icon: 'üì±',
      title: '¬°Bienvenido a tu Lista de Compra!',
      text: 'Esta aplicaci√≥n funciona como una app nativa. Te vamos a mostrar c√≥mo instalarla en tu dispositivo.',
      showInstructions: false
    },
    {
      icon: isIOS ? 'üì§' : '‚ãÆ',
      title: isIOS ? 'Paso 1: Bot√≥n Compartir' : 'Paso 1: Men√∫ del navegador',
      text: isIOS ? 'Toca el bot√≥n de compartir en la parte inferior de Safari' : 'Toca los tres puntos (‚ãÆ) en la esquina superior derecha de Chrome',
      showInstructions: true,
      step: 1
    },
    {
      icon: '‚ûï',
      title: isIOS ? 'Paso 2: A√±adir a Inicio' : 'Paso 2: Instalar App',
      text: isIOS ? 'Busca y toca "A√±adir a pantalla de inicio" en el men√∫' : 'Toca "Instalar app" o "A√±adir a pantalla de inicio"',
      showInstructions: true,
      step: 2
    },
    {
      icon: 'üè†',
      title: '¬°Listo para usar!',
      text: 'Una vez instalada, podr√°s acceder a tu lista de compra directamente desde tu pantalla de inicio, ¬°como cualquier otra app!',
      showInstructions: false
    }
  ];
}

// Actualizar contenido del paso
function updateOnboardingStep() {
  const steps = getOnboardingSteps();
  const currentStep = steps[currentOnboardingStep];
  
  // Actualizar indicadores de progreso
  document.querySelectorAll('.progress-dot').forEach((dot, index) => {
    dot.classList.toggle('active', index <= currentOnboardingStep);
  });
  
  // Actualizar contenido
  document.getElementById('onboardingIcon').textContent = currentStep.icon;
  document.getElementById('onboardingTitle').textContent = currentStep.title;
  document.getElementById('onboardingText').textContent = currentStep.text;
  
  // Mostrar/ocultar instrucciones
  const container = document.getElementById('instructionsContainer');
  if (currentStep.showInstructions) {
    container.style.display = 'block';
    updateInstructionVisual(currentStep.step);
  } else {
    container.style.display = 'none';
  }
  
  // Actualizar bot√≥n
  const nextBtn = document.getElementById('nextOnboarding');
  nextBtn.textContent = currentOnboardingStep === steps.length - 1 ? '¬°Empezar!' : 'Siguiente';
}

// Actualizar visual de instrucciones
function updateInstructionVisual(step) {
  const mockup = document.getElementById('phoneMockup');
  const instructionText = document.getElementById('instructionText');
  
  if (isIOS && step === 1) {
    mockup.innerHTML = `
      <div style="position: absolute; bottom: 10px; left: 0; right: 0; background: #007AFF; color: white; padding: 8px; border-radius: 6px; font-size: 12px;">
        üì§ Safari - Compartir
      </div>
      <div style="position: absolute; top: 20px; font-size: 12px; color: #666;">
        Busca este bot√≥n ‚Üì
      </div>
    `;
    instructionText.innerHTML = '<strong>1.</strong> Toca el bot√≥n de <strong>compartir</strong> en la barra inferior de Safari';
  } else if (isIOS && step === 2) {
    mockup.innerHTML = `
      <div style="background: #f0f0f0; padding: 8px; border-radius: 6px; font-size: 10px; width: 80%;">
        <div style="background: white; padding: 4px; margin: 2px 0; border-radius: 4px;">Compartir foto</div>
        <div style="background: white; padding: 4px; margin: 2px 0; border-radius: 4px;">Copiar enlace</div>
        <div style="background: #007AFF; color: white; padding: 4px; margin: 2px 0; border-radius: 4px;">‚ûï A√±adir a inicio</div>
      </div>
    `;
    instructionText.innerHTML = '<strong>2.</strong> Busca y toca <strong>"A√±adir a pantalla de inicio"</strong>';
  } else if (isAndroid && step === 1) {
    mockup.innerHTML = `
      <div style="position: absolute; top: 10px; right: 10px; font-size: 20px;">‚ãÆ</div>
      <div style="text-align: center; font-size: 12px; color: #666; margin-top: 40px;">
        Toca los tres puntos ‚Üí
      </div>
      <div style="position: absolute; bottom: 10px; left: 0; right: 0; background: #4CAF50; color: white; padding: 8px; border-radius: 6px; font-size: 12px;">
        Men√∫ Chrome
      </div>
    `;
    instructionText.innerHTML = '<strong>1.</strong> Toca los <strong>tres puntos (‚ãÆ)</strong> en la esquina superior derecha';
  } else if (isAndroid && step === 2) {
    mockup.innerHTML = `
      <div style="background: #f0f0f0; padding: 8px; border-radius: 6px; font-size: 10px; width: 80%;">
        <div style="background: white; padding: 4px; margin: 2px 0; border-radius: 4px;">Nueva pesta√±a</div>
        <div style="background: white; padding: 4px; margin: 2px 0; border-radius: 4px;">Historial</div>
        <div style="background: #4CAF50; color: white; padding: 4px; margin: 2px 0; border-radius: 4px;">‚¨áÔ∏è Instalar app</div>
      </div>
    `;
    instructionText.innerHTML = '<strong>2.</strong> Toca <strong>"Instalar app"</strong> en el men√∫';
  }
}

// Siguiente paso del onboarding
function nextOnboardingStep() {
  const steps = getOnboardingSteps();
  if (currentOnboardingStep < steps.length - 1) {
    currentOnboardingStep++;
    updateOnboardingStep();
  } else {
    closeOnboarding();
  }
}

// Cerrar onboarding
function closeOnboarding() {
  document.getElementById('pwaOnboarding').style.display = 'none';
  // Marcar que el usuario ya vio el onboarding
  if (currentUser) {
    db.collection("users").doc(currentUser.uid).update({
      hasSeenOnboarding: true
    });
  }
}

// Mostrar onboarding
function showOnboarding() {
  currentOnboardingStep = 0;
  updateOnboardingStep();
  document.getElementById('pwaOnboarding').style.display = 'flex';
}

// Inicializar cuando carga la p√°gina
document.addEventListener('DOMContentLoaded', initOnboarding);
    

  </script>

  <footer style="text-align: center; margin-top: 40px; padding: 20px; font-size: 10px; border-top: 1px solid #eee;">
  <a href="privacy-policy.html" style="color: #666; text-decoration: none;">Privacy Policy</a>
</footer>
  
</body>
</html>
